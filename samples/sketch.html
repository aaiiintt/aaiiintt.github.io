<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alphabetical Sort Animation</title>
    <style>
        /* Basic styles for the iframe content */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars */
        }
        /* The container will fill the iframe */
        #p5-header-container {
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
    </style>
    <!-- Include the p5.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <!-- Include the Tone.js library for audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
</head>
<body>

    <!-- The p5.js canvas will be placed inside this div -->
    <div id="p5-header-container"></div>

    <script>
        /**
         * p5.js sketch in "instance mode".
         * This wraps the entire sketch in a function to make it a self-contained block.
         * @param {p5} p - The p5 instance.
         */
        const sketch = (p) => {
            let letters = [];
            const initialString = "iain tait";
            const sortedString = "aaiiintt";
            let isSorted = false;
            let container;
            let synth, reverb, delay;

            class Letter {
                constructor(char, initialPos, sortedPos) {
                    this.char = char;
                    this.initialPos = initialPos.copy();
                    this.sortedPos = sortedPos.copy();
                    
                    this.pos = initialPos.copy();
                    this.target = initialPos.copy();
                    this.vel = p.createVector(0, 0);
                    this.acc = p.createVector(0, 0);

                    this.maxSpeed = p.random(4, 8);
                    this.maxForce = p.random(0.1, 0.2);
                    this.slowingRadius = 150;

                    this.noiseOffsetX = p.random(1000);
                    this.noiseOffsetY = p.random(1000);

                    this.color = p.color('#1A1A1A');

                    this.rotation = 0;
                    this.targetRotation = 0;
                }

                update() {
                    let desired = p5.Vector.sub(this.target, this.pos);
                    let distance = desired.mag();
                    if (distance > 1) {
                        let speed = this.maxSpeed;
                        if (distance < this.slowingRadius) {
                            speed = p.map(distance, 0, this.slowingRadius, 0, this.maxSpeed);
                        }
                        desired.setMag(speed);
                        let steer = p5.Vector.sub(desired, this.vel);
                        steer.limit(this.maxForce);
                        this.acc.add(steer);
                    }

                    let wobbleX = p.map(p.noise(this.noiseOffsetX + p.frameCount * 0.01), 0, 1, -0.1, 0.1);
                    let wobbleY = p.map(p.noise(this.noiseOffsetY + p.frameCount * 0.01), 0, 1, -0.1, 0.1);
                    this.acc.add(p.createVector(wobbleX, wobbleY));

                    this.vel.add(this.acc);
                    this.vel.limit(this.maxSpeed);
                    this.pos.add(this.vel);
                    this.acc.mult(0);

                    this.rotation = p.lerp(this.rotation, this.targetRotation, 0.03);
                }

                display() {
                    p.push();
                    p.translate(this.pos.x, this.pos.y);
                    p.rotate(this.rotation);
                    p.fill(this.color);
                    p.noStroke();
                    p.text(this.char, 0, 0);
                    p.pop();
                }
            }

            p.setup = () => {
                container = document.getElementById('p5-header-container');
                let canvas = p.createCanvas(container.clientWidth, 250);
                canvas.parent('p5-header-container');
                p.textFont('Arial');
                p.textAlign(p.CENTER, p.CENTER);

                // Initialize the sound components
                reverb = new Tone.Reverb({
                    decay: 5, // Long reverb tail
                    wet: 0.4
                }).toDestination();

                delay = new Tone.FeedbackDelay("16n", 0.8).connect(reverb);

                synth = new Tone.Synth({
                    oscillator: { type: 'sawtooth' },
                    envelope: {
                        attack: 0.5,
                        decay: 0.6,
                        sustain: 0.3,
                        release: 4
                    }
                }).connect(delay);

                initializeLetters();
            };

            p.windowResized = () => {
                p.resizeCanvas(container.clientWidth, 250);
                initializeLetters();
            };

            p.draw = () => {
                p.clear();
                p.textStyle(p.BOLD);
                p.textSize(100);

                for (let letter of letters) {
                    letter.update();
                    letter.display();
                }
            };

            const playSound = () => {
                // Ensure the audio context is running
                if (Tone.context.state !== 'running') {
                    Tone.context.resume();
                }
                // Trigger the synth to play a low note for a "gong" effect
                synth.triggerAttackRelease('b1', '1n');
            };

            const toggleAnimation = () => {
                playSound(); // Play sound on every toggle
                isSorted = !isSorted;
                for (let letter of letters) {
                    letter.target = isSorted ? letter.sortedPos : letter.initialPos;
                    letter.vel = p5.Vector.random2D().mult(p.random(2, 6));
                    letter.rotation = p.random(-p.PI / 2, p.PI / 2);
                }
            };
            
            p.mousePressed = () => {
                if (p.mouseX > 0 && p.mouseX < p.width && p.mouseY > 0 && p.mouseY < p.height) {
                    toggleAnimation();
                }
            };

            p.touchStarted = () => {
                if (p.touches.length > 0) {
                    const touchX = p.touches[0].x;
                    const touchY = p.touches[0].y;
                    if (touchX > 0 && touchX < p.width && touchY > 0 && touchY < p.height) {
                        toggleAnimation();
                        return false;
                    }
                }
            };

            const initializeLetters = () => {
                letters = [];
                let initialPositions = calculatePositions(initialString);
                let sortedPositions = calculatePositions(sortedString);
                let usedSortedIndices = {};

                for (let i = 0; i < initialString.length; i++) {
                    let char = initialString[i];
                    if (char === ' ') continue;

                    let targetIndex = -1;
                    for (let j = 0; j < sortedString.length; j++) {
                        if (sortedString[j] === char && !usedSortedIndices[j]) {
                            targetIndex = j;
                            usedSortedIndices[j] = true;
                            break;
                        }
                    }

                    if (targetIndex !== -1) {
                        let initialPos = initialPositions[i];
                        let sortedPos = sortedPositions[targetIndex];
                        letters.push(new Letter(char, initialPos, sortedPos));
                    }
                }
                setTimeout(toggleAnimation, 500);
            };

            function calculatePositions(str) {
                let positions = [];
                p.textSize(100);
                p.textStyle(p.BOLD);

                let currentX = 0;
                let y = p.height / 2;

                for (let char of str) {
                    let charWidth = p.textWidth(char);
                    positions.push(p.createVector(currentX + charWidth / 2, y));
                    currentX += charWidth;
                }
                return positions;
            }
        };

        new p5(sketch);
    </script>

</body>
</html>
